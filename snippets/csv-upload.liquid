<style> 
:root {
   --main-bg-color: var(--gradient-base-accent-1);
   --main-color: var(--gradient-base-background-1);
   --hover-brightness: 1.2;
}

.filepond--drop-label {
	color:  var(--main-color)
}

.filepond--panel-root {
  background-color: var(--main-bg-color);
}

.filepond--root { 
	margin: 0 auto;
  background-color: var(--main-bg-color);
}

.filepond--root:hover {
  filter: brightness(var(--hover-brightness));
}
</style>


{%- if section.settings.api_key != blank -%}
{%- endif -%}

{% assign server_address = "https://api.wp-dataanalytics.de/shopify/csvupload" %}

<div>
<div class="wp-upload--wrapper " id="wpaa5822d2">
      <input id='wp-upload' type="file" class="filepond" name="file" accept=".csv"/>
    </label>  
</div>
<p>{{section.settings.message }} <span><a href="{{'csv_orders.csv' | file_url }}" download>{{section.settings.download}}</a></span></p>
</div>
<script>
  
function addToCart(data){
    fetch('/cart/add.js', {
          method: 'POST',
          headers: {
             'Content-Type': 'application/json'
          },
          body: data
})
.then(response => response.json())
.then(setTimeout(()=>location.href='/cart',3000))
.catch((error) => {
  console.error('Error:', error);
   });
  }
 
document.addEventListener('FilePond:loaded', e => {

const pond=FilePond.create(
	document.getElementById('wp-upload'),
	{
		labelIdle: "{{ section.settings.labelIdle }}",
    labelFileProcessing: "{{ section.settings.labelFileProcessing }}",
    labelFileProcessingComplete: "{{ section.settings.labelFileProcessingComplete }}",
    labelFileProcessingAborted: "{{ section.settings.labelFileProcessingAborted }}",
    labelTapToRetry: "{{ section.settings.labelFileProcessingAborted }}"
    //labelFileProcessingError: "{{ section.settings.labelFileProcessingError }}",
	}
);
let serverResponse = '';
pond.setOptions({
  server:{
    url: '{{ server_address }}',
    process: {
      url:'/orders/{{shop.domain}}',
      onload: response=>{addToCart(response)},
      onerror: response=>{
        serverResponse = JSON.parse(response)
      }
    },
    revert: null,
    fetch: null
    },
    labelFileProcessingError: error => {
        return serverResponse !==''?serverResponse.detail:"{{ section.settings.labelFileProcessingError }}"
    }
  }
);
});
</script>
